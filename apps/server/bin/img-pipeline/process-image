#!/bin/bash
# 设置工具路径
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
export PATH="$SCRIPT_DIR:$PATH"

# process-image: 处理单张图片（幂等）
# Usage: process-image <image_file> [output_dir]
# 幂等性: 基于文件 hash，重复处理同一文件会跳过
set -e

IMAGE_FILE="$1"
OUTPUT_DIR="${2:-${IMG_PIPELINE_OUTPUT_DIR:-$HOME/output}}"

if [ $# -lt 1 ] || [ ! -f "$IMAGE_FILE" ]; then
    echo "Usage: process-image <image_file> [output_dir]" >&2
    exit 1
fi

check_ollama() {
    if [ "${SKIP_OLLAMA_CHECK:-0}" = "1" ]; then
        return
    fi

    if ! command -v curl &> /dev/null; then
        echo "Error: curl not found. Please install curl." >&2
        exit 1
    fi

    if ! command -v ollama &> /dev/null; then
        echo "Error: ollama not found. Install from https://ollama.com" >&2
        exit 1
    fi

    local tags
    tags=$(curl -s --max-time 5 http://localhost:11434/api/tags || true)
    if [ -z "$tags" ]; then
        echo "Error: Ollama service not running. Start: ollama serve" >&2
        exit 1
    fi

    if ! echo "$tags" | grep -q "qwen3-vl:2b"; then
        echo "Error: model qwen3-vl:2b not found. Run: ollama pull qwen3-vl:2b" >&2
        exit 1
    fi
    if ! echo "$tags" | grep -q "qwen3-embedding:0.6b"; then
        echo "Error: model qwen3-embedding:0.6b not found. Run: ollama pull qwen3-embedding:0.6b" >&2
        exit 1
    fi
}

check_ollama

# 获取文件 hash（幂等标识）
HASH=$(img-hash "$IMAGE_FILE")
BASENAME=$(basename "$IMAGE_FILE")

# 定义输出路径
DESC_FILE="$OUTPUT_DIR/descriptions/${HASH}.txt"
META_FILE="$OUTPUT_DIR/metadata/${HASH}.json"
EMBED_FILE="$OUTPUT_DIR/embeddings/${HASH}.json"
LOG_FILE="$OUTPUT_DIR/logs/process.log"

mkdir -p "$OUTPUT_DIR"/{descriptions,metadata,embeddings,logs}

# 检查是否已处理（幂等检查）
if [ -f "$DESC_FILE" ] && [ -f "$META_FILE" ]; then
    echo "SKIP: $BASENAME (hash: ${HASH:0:16}...) already processed" >&2
    echo "$HASH"
    exit 0
fi

echo "Processing: $BASENAME (hash: ${HASH:0:16}...)" >&2

# 1. 提取元数据
img-exif "$IMAGE_FILE" > "$META_FILE" 2>/dev/null || echo '{"error": "exif failed"}' > "$META_FILE"

# 2. 生成描述
img-describe "$IMAGE_FILE" > "$DESC_FILE" 2>/dev/null || echo "Description generation failed" > "$DESC_FILE"

# 3. 组合文本并生成嵌入
{
    echo "File: $BASENAME"
    echo "Description:"
    cat "$DESC_FILE"
} | img-embed > "$EMBED_FILE" 2>/dev/null || echo '{"error": "embed failed"}' > "$EMBED_FILE"

# 记录日志
echo "$(date -Iseconds) $HASH $BASENAME" >> "$LOG_FILE"

# 输出 hash
echo "$HASH"
