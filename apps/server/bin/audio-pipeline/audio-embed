#!/usr/bin/env python3
"""audio-embed: 为音频转写文本生成嵌入向量 (使用 Ollama qwen3-embedding)
Usage: audio-embed [--input-json FILE | --text "TEXT"]
Output: JSON with embedding vector
"""

import argparse
import json
import os
import sys
from pathlib import Path
import urllib.request
import urllib.error


OLLAMA_URL = os.environ.get("OLLAMA_URL", "http://localhost:11434/api/embeddings")
DEFAULT_MODEL = os.environ.get("AUDIO_EMBED_MODEL", "qwen3-embedding:0.6b")


def get_embedding(text: str, model: str = DEFAULT_MODEL) -> list:
    """调用 Ollama API 获取文本嵌入"""
    data = json.dumps({
        "model": model,
        "prompt": text
    }).encode('utf-8')
    
    req = urllib.request.Request(
        OLLAMA_URL,
        data=data,
        headers={'Content-Type': 'application/json'},
        method='POST'
    )
    
    try:
        with urllib.request.urlopen(req, timeout=120) as resp:
            result = json.loads(resp.read().decode('utf-8'))
            return result.get('embedding', [])
    except urllib.error.URLError as e:
        raise RuntimeError(f"Ollama API error: {e}")


def main():
    parser = argparse.ArgumentParser(description="Generate embedding for audio transcription")
    parser.add_argument("--input-json", type=Path, help="Path to transcription JSON file")
    parser.add_argument("--text", help="Direct text input")
    parser.add_argument("--model", default=DEFAULT_MODEL, help="Ollama embedding model")
    parser.add_argument("--output", type=Path, help="Output JSON file")
    
    args = parser.parse_args()
    
    # Get input text
    if args.input_json:
        with open(args.input_json, 'r', encoding='utf-8') as f:
            data = json.load(f)
        text = data.get('text', '')
        file_hash = data.get('hash', '')
    elif args.text:
        text = args.text
        file_hash = ''
    else:
        # Read from stdin
        text = sys.stdin.read().strip()
        file_hash = ''
    
    if not text:
        print(json.dumps({"error": "No text provided"}, ensure_ascii=False))
        sys.exit(1)
    
    try:
        embedding = get_embedding(text, args.model)
        
        output = {
            "text": text[:500],  # Truncate for storage
            "embedding": embedding,
            "model": args.model,
            "dimensions": len(embedding)
        }
        
        if file_hash:
            output["hash"] = file_hash
        
        # Save to file if specified
        if args.output:
            with open(args.output, 'w', encoding='utf-8') as f:
                json.dump(output, f, ensure_ascii=False)
        
        print(json.dumps(output, ensure_ascii=False))
        
    except Exception as e:
        print(json.dumps({"error": str(e)}, ensure_ascii=False))
        sys.exit(1)


if __name__ == "__main__":
    raise SystemExit(main())
